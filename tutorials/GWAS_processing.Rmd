---
title: "GWAS preprocessing for _seismic_ input"
author: "Qiliang Lai"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GWAS preprocessing for seismic input}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
root_dir = "seismic-analysis" #change it to the repo directory
knitr::opts_knit$set(root.dir = root_dir)
```

## Introduction

The _seismic_ framework takes the output from [MAGMA](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004219) as input. 
This tutorial will guide you through the preprocessing steps necessary to convert raw GWAS summary statistics into the proper format for _seismic_ analysis.
Before beginning, ensure you have installed the MAGMA software and obtained the required files:
- Gene location file
- SNP synonyms file (dbSNP)
- Population-specific reference data
These files can be all downloaded from the [MAGMA website](https://cncr.nl/research/magma/). 

## Step 1: Clean up the GWAS summary statistics file
The minimum required information in your GWAS summary statistics file includes:
- Chromosome ID column
- Base-pair position column
- P value column
Additionally, we strongly recommend including SNP IDs (rsIDs) to facilitate MAGMA analysis. Here's an example of how your data might look:

```{r load packages, echo=TRUE, message=FALSE, warning=FALSE}
#load packages
library(magrittr)
library(dplyr)
library(rtracklayer) #for lift over
```
```{r load data}
#load data
example_gwas <- read.table("data/gwas/sample_gwas/sample_gwas.txt", header = T) %>% as_tibble() #your data path

head(example_gwas)
```

## Step 2: Map the SNP location to GRCh37 
For MAGMA gene analysis, the required population-specific reference data is based on the GRCh37 genome build, all SNP location should be converted to GRCh37 (Hg19).
The example data file shown above is a GWAS summary statistics file based on the GRCh38 genome build.
To map the SNP location to GRCh37, we can use the [LiftOver tool](https://genome.ucsc.edu/cgi-bin/hgLiftOver) provided by UCSC. 
Here is an example of how to convert the SNP location with the chain object "hg38ToHg19.over.chain.gz" downloaded from the [UCSC website](https://hgdownload.cse.ucsc.edu/goldenpath/hg19/liftOver/), together with the rtrackler package in R. 

```{r map to hg19, echo=TRUE}
#load the chain object
chainObject <- import.chain("data/ref/hg38ToHg19.over.chain") #your downloaded chain object

#Granges object with the bed information. The seqnames are named with "chr" prefix.
grObject <- GRanges(seqnames=paste0("chr", example_gwas$Chromosome),
                   ranges=IRanges(start=as.numeric(example_gwas$BP), end=as.numeric(example_gwas$BP)+1))

#lift over
hg19_res <- liftOver(grObject, chainObject)

#extract the result data frame, select the necessary columns
hg19_res_df <- as.data.frame(hg19_res) %>% #get the result data frame
  mutate(seqnames = gsub(seqnames, pattern = "chr",replacement = "")) %>% #change pattern back
  select(group, start, seqnames) %>%
  rename("start" = "BP", "seqnames" = "Chromosome") #rename columns

#get the 1 to 1 mapping
hg19_res_df <- hg19_res_df %>% group_by(group) %>% 
  filter(n()==1) %>%
  ungroup() 

#merge with the original data frame (the group column indicates the original position in the table)
example_gwas <- example_gwas %>%
  mutate(group = 1:n()) %>%  #original order 
  select(-Chromosome, -BP) %>% #remove the original column
  left_join(hg19_res_df , by = "group") %>% #left join annotation
  filter(!is.na(BP)) #filter unmapped data

#write out for later
write.table(example_gwas %>% mutate(BP = as.character(BP)),  #avoid numerical output 
            file = "data/gwas/sample_gwas/sample_gwas_hg19.txt", 
            sep="\t", col.names = T, row.names = F, quote = F)

head(example_gwas)
```

## Step 3: Map the SNP location to SNP ID
If the SNP ID is not included in the GWAS summary statistics file, we can use the SNP synonyms file to map the SNP location to SNP ID. 
To simplify the procedure, we implement a bash script in `tools/annotate_SNP.sh` for the step, where [bedtools](https://bedtools.readthedocs.io/en/latest/) is required.
This script will require the dbSNP file and the GWAS summary statistics file as input, and output a new file with SNP ID included in the last column.
To view all specific parameters of the script, you can run the following command in the terminal: 

```{bash preview annotate_snp}
bash src/tools/annotate_SNP.sh -h
```

Here is an example of how to run the script with the example data file:
```{bash annotate_snp, eval=FALSE, echo=TRUE}
bash src/tools/annotate_SNP.sh -g data/gwas/sample_gwas/sample_gwas_hg19.txt -o data/gwas/sample_gwas/sample_gwas_hg19 \
-c 6 -p 7 -v data/ref/Hg19.dbsnp151.vcf -t bin/bedtools
```
Note that the script may takes hours to run and consumes more than 100 GB of memory. To alleviate memory usage (but increase the running time), the `-n` option may be used to sequentially split the task into several. 
The annotated table will be printed with the path and header specified by the `-o` option. 
```{bash, engine.opts = '-l' }
head data/gwas/sample_gwas/sample_gwas_hg19.annot.table
```

## Step 4: Generate the input file for MAGMA
The software takes two input files generated from the previously processed (or unprocessed but with the required columns) GWAS summary statistics file: a SNP location file and a P value file.
You can simply use the `awk` command to extract the information, for example:
```{bash generate input-shell}
#print rsID, chromosome, BP but not colum names:
#starting from the second line (NR>1), field 8, 6, 7
awk '{if (NR>1) print $8, $6, $7}' data/gwas/sample_gwas/sample_gwas_hg19.annot.table > data/gwas/sample_gwas/sample_gwas_hg19.snp_loc.txt
#print rsID, Pvalue but not colum names:
#starting from the second line (NR>1), field 8, 4
awk '{if (NR>1) print $8, $4}' data/gwas/sample_gwas/sample_gwas_hg19.annot.table > data/gwas/sample_gwas/sample_gwas_hg19.p_val.txt
```

or in R:
```{r generate input-R}
anno_tbl <- read.table("data/gwas/sample_gwas/sample_gwas_hg19.annot.table", header=T)
anno_tbl %>% select(marker.name, Chromosome, BP) %>% write.table(file = "data/gwas/sample_gwas/sample_gwas_hg19.snp_loc.txt", col.names = F, row.names = F, quote = F, sep="\t")
anno_tbl %>% select(marker.name, P.value) %>% write.table(file = "data/gwas/sample_gwas/sample_gwas_hg19.p_val.txt", col.names = F, row.names = F, quote = F, sep="\t")
```

Data preview:
```{bash data preview}
head  data/gwas/sample_gwas/sample_gwas_hg19.snp_loc.txt
```

## Step 5: Run MAGMA software
There are two steps: gene annotation and gene analysis. You can use our implemented bash script `tools/magma_gene_zscore_analysis.sh` to run the two steps together. 
Another paramter to specificy is the gene analysis window size, which is set as 35 kilobase (kb) upstream to 10 kb downstream by default, as recommend by [the previous study](https://www.nature.com/articles/s41588-020-0610-9).
Although we have shown that output files from various window sizes make only a minor difference in the results of _seismic_ analysis, you can still change the window size by specifying the parameter `--window-size` in the script. 
To view all specific parameters of the script, you can run the following command in the terminal:
```{bash preview magma_gene_zscore_analysis}
bash src/tools/magma_gene_zscore_analysis.sh -h
```


```{bash magma_gene_zscore_analysis, eval=FALSE, echo=TRUE}
bash src/tools/magma_gene_zscore_analysis.sh -l data/gwas/sample_gwas/sample_gwas_hg19.snp_loc.txt \
-p data/gwas/sample_gwas/sample_gwas_hg19.p_val.txt \
-o data/gwas/sample_gwas \
-s 100000 -m bin/magma/magma -g data/ref/magma/NCBI37.3/NCBI37.3.gene.loc -b data/ref/magma/g1000_eur/g1000_eur 
```
Besides specifying these reference file paths and the curated files from the summary statistics, the total size of the cohort should also be specified. Note that sometimes the cohort size for each SNP may be different, for example, due to some quality control procedure. In that case, a separate column in the p-value file should be added and the input `-s` argument should tell the script the order of the column (for example, the third column) describing the cohort size. By specifying these arguments, the gene-level MAGMA z-score will be printed out in the output directory with header similar to the snp location file. Here the output file is `data/gwas/sample_gwas/sample_gwas_hg19.35.10.genes.out`. In addition, please do remember to check the MAGMA running log. Sometimes when the data are not in the correct format, there will be very few genes and SNPs annotated (for example, less than 10% of the SNPs).

