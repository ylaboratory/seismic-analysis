#script to generate data for causal simulation
if (!require("here")){
  install.packages("here")
  library("here")
}
if (!require("magrittr")){
  install.packages("magrittr")
  library("magrittr")
}
if(!require("tidyverse")){
  install.packages("tidyverse")
  library("tidyverse")
}
if (!require("SingleCellExperiment")){
  if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
  BiocManager::install("SingleCellExperiment")
  library("SingleCellExperiment")
} 
library("scDesign3")

#load objects
load(here("data","ref","mapping","mmu_hsa_mapping.rda"))

#load functions
source(here("src","tools","sparse_mat_util.R"))
source(here("src","tools","munge_sce_mat.R"))

##### load random gene sets generated by null_sum_data_proc.R ####
zscore_dir <- here("data","gwas","causal_sim","zscore")
scdrs_dir <- here("data","gwas","causal_sim","scdrs_gs")
magma_raw_dir <- here("data","gwas","causal_sim","magma_raw")
expr_dir <- here("data","expr","null_sim","expr_rda_rs")
h5ad_dir <- here("data","expr","null_sim","expr_h5ad_rs")

#load all random gene sets generated
z_score_list <- list.files(zscore_dir) %>%
  set_names(gsub(pattern = ".genes.out", replacement = "", x = ., fixed = T)) %>%
  map(~read.table(file=paste0(zscore_dir,"/",.x), header = T)) %>%
  map(~left_join(.x, distinct(mmu_hsa_mapping, hsa_entrez, mmu_symbol), by = c("GENE"="hsa_entrez"))) #join with gene mapping

#load expression data
expr_list <- list.files(expr_dir) %>%
  set_names(gsub(pattern = ".rda", replacement = "", x = ., fixed = T)) %>%
  map(~{load(paste0(expr_dir,"/",.x)); return(sce)})  %>%
  map(~{colnames(.x) <- .x$cellid; .x})

#see if they are in original expression data sets
z_score_list <- z_score_list %>%
  map(~mutate(.x, in_expr = ifelse(mmu_symbol %in% rownames(expr_list$expr_ds_1), T, F))) %>%
  map(~filter(.x, in_expr)) %>% 
  map(~group_by(.x, mmu_symbol)) %>%
  map(~mutate(.x, ZSTAT = mean(ZSTAT))) %>%
  map(~ungroup(.x)) %>%
  map(~distinct(.x,mmu_symbol, .keep_all = T)) %>%
  map(~arrange(.x, -ZSTAT)) 


##### function definition for scdDesign3 data generation ######
perturb_count_matrix <- function(sce, covar_df, cellids, geneids, effect_size_para, copula_para_list, para_list ){
  gene_idx <- match(geneids, rownames(sce))
  gene_loc <- match(geneids, colnames(copula_para_list$`1`)) #gene index in copula matrix
  cell_idx <- match(cellids, colnames(sce))
  covar_df <- dplyr::slice(covar_df, cell_idx)
  new_count_mat <- simu_new(
    sce = sce[gene_idx, cell_idx],
    mean_mat = para_list$mean_mat[cell_idx, gene_idx] %>% sweep(MARGIN = 1, STATS = effect_size_para, FUN = "*"),
    sigma_mat = para_list$sigma_mat[cell_idx, gene_idx],
    zero_mat = para_list$zero_mat[cell_idx, gene_idx],
    quantile_mat = NULL,
    copula_list = list("1" = copula_para_list$`1`[gene_loc, gene_loc]),
    n_cores = 10,
    family_use = "nb",
    input_data = mutate(covar_df, corr_group = 1),
    new_covariate = covar_df,
    important_feature = "all",
    filtered_gene = NULL #since all genes have expression in more than 2 cells
  )
  return(new_count_mat)
}

##### Generate simulated data sets for standard ####
sc3_standard_gene_anno_dir <- here("data","gwas","causal_sim","sc3_standard","gene_anno")
sc3_standard_cell_anno_dir <- here("data","expr","causal_sim","sc3_standard","cell_anno")
sc3_standard_perturbed_expr_dir <- here("data","expr","causal_sim","sc3_standard","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
load("data/expr/causal_sim/standard_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
set.seed(98)
standard_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, is_target = ifelse(1:n() %in% sample(n(), 100), T, F))) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(is_target, "target_cell_type", cell_ontology_class))) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) %>%
  map( ~mutate(.x, cell_ontology_class = new_cell_ontology_class))

expr_list <- map2(expr_list, standard_cell_anno, ~{.x$cell_ontology_class <- .y$new_cell_ontology_class; .x}) 

##sample random gene sets
standard_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10)))

standard_gene_anno <- map(standard_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

set.seed(100)
standard_gene_anno = standard_gene_anno %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 250), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 750), T, F)))) 

##write out tables
map2(standard_cell_anno, names(standard_cell_anno), ~write.table(.x, file = paste0(sc3_standard_cell_anno_dir, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
#
map2(standard_gene_anno, names(standard_gene_anno), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_standard_gene_anno_dir, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = seq(0, 2, 0.1) %>% set_names(paste0("es_", format(.,digits = 1)))

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_standard_perturbed_expr_dir, "/",es_name), showWarnings = FALSE)
  map2(standard_gene_anno, names(standard_gene_anno), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- standard_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type"]
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_standard_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
sc3_standard_para_df <- expand_grid(es_name = names(effect_size),
                                gs_name = names(z_score_list),
                                expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_standard_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_standard_gene_anno_dir, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_standard_cell_anno_dir, "/", expr_name, ".cell_anno.txt"))

#write out parameter data frame
write.table(sc3_standard_para_df, file = paste0(sc3_standard_perturbed_expr_dir, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)






##### Generate simulated data sets for a random cell type ####
sc3_ct_gene_anno_dir <- here("data","gwas","causal_sim","sc3_ct","gene_anno")
sc3_neuro_gene_anno_dir <- here("data","gwas","causal_sim","sc3_neuro","gene_anno")

sc3_ct_cell_anno_dir <- here("data","expr","causal_sim","sc3_ct","cell_anno")
sc3_neuro_cell_anno_dir <- here("data","expr","causal_sim","sc3_neuro","cell_anno")

sc3_ct_perturbed_expr_dir <- here("data","expr","causal_sim","sc3_ct","perturbed_expr")
sc3_neuro_perturbed_expr_dir <- here("data","expr","causal_sim","sc3_neuro","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
load("data/expr/causal_sim/ct_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
ct_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(cell_ontology_class == "B cell", "target_cell_type", cell_ontology_class))) %>%
  map(~mutate(.x, cell_ontology_class = new_cell_ontology_class)) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 

neuro_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(cell_ontology_class == "neuron", "target_cell_type", cell_ontology_class))) %>%
  map(~mutate(.x, cell_ontology_class = new_cell_ontology_class)) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 

expr_list <- map2(expr_list, ct_cell_anno, ~{.x$library_size <- .y$library_size; .x}) 

##sample random gene sets
ct_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map2(ct_cell_anno, ~.x[, colnames(.x) %in% pull(filter(.y, cell_ontology_class == "target_cell_type"), cellid)]) %>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 5)))

neuro_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map2(neuro_cell_anno, ~.x[, colnames(.x) %in% pull(filter(.y, cell_ontology_class == "target_cell_type"), cellid)]) %>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 5)))

#this is  modified
ct_gene_anno <- map(ct_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

#this is modified
neuro_gene_anno <- map(neuro_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

set.seed(100)
ct_gene_anno = ct_gene_anno %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 250), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 750), T, F)))) 

neuro_gene_anno = neuro_gene_anno %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 250), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 750), T, F)))) 

##write out tables
map2(ct_cell_anno, names(ct_cell_anno), ~write.table(.x, file = paste0(sc3_ct_cell_anno_dir, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(neuro_cell_anno, names(neuro_cell_anno), ~write.table(.x, file = paste0(sc3_neuro_cell_anno_dir, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))

#write out gene annotation tables
map2(ct_gene_anno, names(ct_gene_anno), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_ct_gene_anno_dir, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})
map2(neuro_gene_anno, names(ct_gene_anno), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_neuro_gene_anno_dir, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = seq(0, 2, 0.1) %>% set_names(paste0("es_", format(.,digits = 1)))

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_ct_perturbed_expr_dir, "/",es_name), showWarnings = FALSE)
  map2(ct_gene_anno, names(ct_gene_anno), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- colData(sce) %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- rownames(coldata_df)[ct_cell_anno[[expr_name]]$cell_ontology_class == "target_cell_type"]
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_ct_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_neuro_perturbed_expr_dir, "/",es_name), showWarnings = FALSE)
  map2(neuro_gene_anno, names(neuro_gene_anno), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- colData(sce) %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- rownames(coldata_df)[neuro_cell_anno[[expr_name]]$cell_ontology_class == "target_cell_type"]
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_neuro_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
sc3_ct_para_df <- expand_grid(es_name = names(effect_size),
                                gs_name = names(z_score_list),
                                expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_ct_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_ct_gene_anno_dir, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_ct_cell_anno_dir, "/", expr_name, ".cell_anno.txt"))

sc3_neuro_para_df <- expand_grid(es_name = names(effect_size),
                              gs_name = names(z_score_list),
                              expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_neuro_perturbed_expr_dir, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_neuro_gene_anno_dir, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_neuro_cell_anno_dir, "/", expr_name, ".cell_anno.txt"))

#write out parameter data frame
write.table(sc3_ct_para_df, file = paste0(sc3_ct_perturbed_expr_dir, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_neuro_para_df, file = paste0(sc3_neuro_perturbed_expr_dir, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)


##### Try different number of causal genes #####
sc3_gene_num_gene_anno_dir_100 <- here("data","gwas","causal_sim","sc3_gene_num","gene_100","gene_anno")
sc3_gene_num_gene_anno_dir_400 <- here("data","gwas","causal_sim","sc3_gene_num","gene_400","gene_anno")

sc3_gene_num_cell_anno_dir_100 <- here("data","expr","causal_sim","sc3_gene_num","gene_100","cell_anno")
sc3_gene_num_cell_anno_dir_400 <- here("data","expr","causal_sim","sc3_gene_num","gene_400","cell_anno")

sc3_gene_num_perturbed_expr_dir_100 <- here("data","expr","causal_sim","sc3_gene_num","gene_100","perturbed_expr")
sc3_gene_num_perturbed_expr_dir_400 <- here("data","expr","causal_sim","sc3_gene_num","gene_400","perturbed_expr")
#sc3_gene_num_perturbed_expr_dir_100_new <- here("data","expr","causal_sim","sc3_gene_num_new","gene_100","perturbed_expr")
#sc3_gene_num_perturbed_expr_dir_400_new <- here("data","expr","causal_sim","sc3_gene_num_new","gene_400","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
#load("data/expr/causal_sim/ct_scdesign3_model/sc_para_list.rda")
load("data/expr/causal_sim/standard_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
set.seed(98)
gene_num_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, is_target = ifelse(1:n() %in% sample(n(), 100), T, F))) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(is_target, "target_cell_type", cell_ontology_class))) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 

##sample random gene sets
gene_num_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20] )) #get genes without starange parameter fitted


gene_num_gene_anno_all <- map(gene_num_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))


set.seed(100)
gene_num_gene_anno_100 = gene_num_gene_anno_all %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 100), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 900), T, F)))) 

gene_num_gene_anno_400 = gene_num_gene_anno_all %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 400), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 600), T, F)))) 

##write out cell annotation tables
map2(gene_num_cell_anno, names(gene_num_cell_anno), ~write.table(.x, file = paste0(sc3_gene_num_cell_anno_dir_100, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(gene_num_cell_anno, names(gene_num_cell_anno), ~write.table(.x, file = paste0(sc3_gene_num_cell_anno_dir_400, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))

##write out gene tables
map2(gene_num_gene_anno_100, names(gene_num_gene_anno_100), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_gene_num_gene_anno_dir_100, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(gene_num_gene_anno_400, names(gene_num_gene_anno_400), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_gene_num_gene_anno_dir_400, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = seq(0, 2, 0.1) %>% set_names(paste0("es_", format(.,digits = 1)))
effect_size = effect_size[c( "es_1.0", "es_2.0")] #subset for testing

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  #dir.create(paste0(sc3_gene_num_perturbed_expr_dir_100, "/",es_name), showWarnings = FALSE)
  dir.create(paste0(sc3_gene_num_perturbed_expr_dir_100, "/",es_name), showWarnings = FALSE)
  map2(gene_num_gene_anno_100, names(gene_num_gene_anno_100), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- rownames(coldata_df)[gene_num_cell_anno[[expr_name]]$new_cell_ontology_class == "target_cell_type"] #target cell type
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      #write.table(as.matrix(out_mat), file = paste0(sc3_gene_num_perturbed_expr_dir_100, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      write.table(as.matrix(out_mat), file = paste0(sc3_gene_num_perturbed_expr_dir_100, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  #dir.create(paste0(sc3_gene_num_perturbed_expr_dir_400, "/",es_name), showWarnings = FALSE)
  dir.create(paste0(sc3_gene_num_perturbed_expr_dir_400, "/",es_name), showWarnings = FALSE)
  map2(gene_num_gene_anno_400, names(gene_num_gene_anno_400), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- rownames(coldata_df)[gene_num_cell_anno[[expr_name]]$new_cell_ontology_class == "target_cell_type"] #target cell type
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      #write.table(as.matrix(out_mat), file = paste0(sc3_gene_num_perturbed_expr_dir_400, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      write.table(as.matrix(out_mat), file = paste0(sc3_gene_num_perturbed_expr_dir_400, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
sc3_gene_num_para_df_100 <- expand_grid(es_name = names(effect_size),
                                    gs_name = names(z_score_list),
                                    expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_gene_num_perturbed_expr_dir_100, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_gene_num_gene_anno_dir_100, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_gene_num_cell_anno_dir_100, "/", expr_name, ".cell_anno.txt"))

sc3_gene_num_para_df_400 <- expand_grid(es_name = names(effect_size),
                                        gs_name = names(z_score_list),
                                        expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_gene_num_perturbed_expr_dir_400, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_gene_num_gene_anno_dir_400, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_gene_num_cell_anno_dir_400, "/", expr_name, ".cell_anno.txt"))

#write out parameter data frame
write.table(sc3_gene_num_para_df_100 , file = paste0(sc3_gene_num_perturbed_expr_dir_100, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_gene_num_para_df_400, file = paste0(sc3_gene_num_perturbed_expr_dir_400, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)



##### Try different ratio of cells #####
sc3_cell_num_gene_anno_dir_20 <- here("data","gwas","causal_sim","sc3_cell_num","cell_20","gene_anno")
sc3_cell_num_gene_anno_dir_50 <- here("data","gwas","causal_sim","sc3_cell_num","cell_50","gene_anno")

sc3_cell_num_cell_anno_dir_20 <- here("data","expr","causal_sim","sc3_cell_num","cell_20","cell_anno")
sc3_cell_num_cell_anno_dir_50 <- here("data","expr","causal_sim","sc3_cell_num","cell_50","cell_anno")

sc3_cell_num_perturbed_expr_dir_20 <- here("data","expr","causal_sim","sc3_cell_num","cell_20","perturbed_expr")
sc3_cell_num_perturbed_expr_dir_50 <- here("data","expr","causal_sim","sc3_cell_num","cell_50","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
load("data/expr/causal_sim/ct_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
set.seed(98)
cell_num_cell_anno_all <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, is_target = ifelse(1:n() %in% sample(n(), 100), T, F))) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(is_target, "target_cell_type", cell_ontology_class))) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 

cell_num_cell_anno_20 <- cell_num_cell_anno_all %>%
  map(~filter(.x, new_cell_ontology_class == "target_cell_type")) %>%
  map(~pull(.x, cellid)) %>%
  map(~{
    cell_list = .x
    map(z_score_list, ~sample(cell_list, size = 20))
  }) %>%
  map2(cell_num_cell_anno_all, ~{
    cell_anno_tbl = .y
    map(.x, ~mutate(cell_anno_tbl, is_perturbed = ifelse(cellid %in% .x, T,F)))
  })

cell_num_cell_anno_50 <- cell_num_cell_anno_all %>%
  map(~filter(.x, new_cell_ontology_class == "target_cell_type")) %>%
  map(~pull(.x, cellid)) %>%
  map(~{
    cell_list = .x
    map(z_score_list, ~sample(cell_list, size = 50))
  }) %>%
  map2(cell_num_cell_anno_all, ~{
    cell_anno_tbl = .y
    map(.x, ~mutate(cell_anno_tbl, is_perturbed = ifelse(cellid %in% .x, T,F)))
  })


##sample random gene sets
cell_num_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20] )) #get genes without strange parameter fitted

cell_num_gene_anno_all <- map(cell_num_candidate_gene_list, ~{
    gl <- .x
    map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

set.seed(100)
cell_num_gene_anno_all = cell_num_gene_anno_all %>%
  map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(filter(., may_be_causal)$mmu_symbol, 300), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 700), T, F)))) 

##write out cell annotation tables
map2(cell_num_cell_anno_20, names(cell_num_cell_anno_20), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_cell_num_cell_anno_dir_20, "/",expr_name,".", .y,".cell_anno.txt"), quote = F,row.names = F,sep = "\t"))})

map2(cell_num_cell_anno_50, names(cell_num_cell_anno_50), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_cell_num_cell_anno_dir_50, "/",expr_name,".", .y,".cell_anno.txt"), quote = F,row.names = F, sep="\t"))})

##write out gene tables
map2(cell_num_gene_anno_all, names(cell_num_gene_anno_all), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_cell_num_gene_anno_dir_20, "/",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(cell_num_gene_anno_all, names(cell_num_gene_anno_all), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_cell_num_gene_anno_dir_50, "/",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = seq(0, 2, 0.1) %>% set_names(paste0("es_", format(.,digits = 1)))
effect_size = effect_size[c( "es_1.0", "es_2.0")] #subset for testing

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_cell_num_perturbed_expr_dir_20, "/",es_name), showWarnings = FALSE)
  map2(cell_num_gene_anno_all, names(cell_num_gene_anno_all), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    cell_anno_list = cell_num_cell_anno_20[[expr_name]]
    #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      coldata_df <-  cell_anno_list[[gs_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
      
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- cell_anno_list[[gs_name]]$cellid[cell_anno_list[[gs_name]]$is_perturbed] #target cell type
      all_cell_list <- cell_anno_list[[gs_name]]$cellid[cell_anno_list[[gs_name]]$is_target]
      
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para) %>%
        as.matrix()
      
      aux_mat <- assay(sce, "counts")[match(gene_list, rownames(sce)), match(all_cell_list, colnames(sce))] %>% 
        as.matrix()
      
      aux_mat[, match(cell_list, all_cell_list)] <- out_mat
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_cell_num_perturbed_expr_dir_20, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_cell_num_perturbed_expr_dir_50, "/",es_name), showWarnings = FALSE)
  map2(cell_num_gene_anno_all, names(cell_num_gene_anno_all), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    cell_anno_list = cell_num_cell_anno_50[[expr_name]]
    #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      coldata_df <-  cell_anno_list[[gs_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
      
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- cell_anno_list[[gs_name]]$cellid[cell_anno_list[[gs_name]]$is_perturbed] #target cell type
      all_cell_list <- cell_anno_list[[gs_name]]$cellid[cell_anno_list[[gs_name]]$is_target]
      
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para) %>%
        as.matrix()
      
      aux_mat <- assay(sce, "counts")[match(gene_list, rownames(sce)), match(all_cell_list, colnames(sce))] %>% 
        as.matrix()
      
      aux_mat[, match(cell_list, all_cell_list)] <- out_mat
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_cell_num_perturbed_expr_dir_50, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
sc3_cell_num_para_df_20 <- expand_grid(es_name = names(effect_size),
                                        gs_name = names(z_score_list),
                                        expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_cell_num_perturbed_expr_dir_20, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_cell_num_gene_anno_dir_20, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_cell_num_cell_anno_dir_20, "/", expr_name,".",gs_name, ".cell_anno.txt"))

sc3_cell_num_para_df_50 <- expand_grid(es_name = names(effect_size),
                                       gs_name = names(z_score_list),
                                       expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_cell_num_perturbed_expr_dir_50, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_cell_num_gene_anno_dir_50, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_cell_num_cell_anno_dir_50, "/", expr_name, ".",gs_name,".cell_anno.txt"))

#write out parameter data frame
write.table(sc3_cell_num_para_df_20, file = paste0(sc3_cell_num_perturbed_expr_dir_20, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_cell_num_para_df_50, file = paste0(sc3_cell_num_perturbed_expr_dir_50, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)

##### Try probabilistic gene sets #####
sc3_prob_gene_anno_dir_200 <- here("data","gwas","causal_sim","sc3_prob","gene_200","gene_anno")
sc3_prob_gene_anno_dir_300 <- here("data","gwas","causal_sim","sc3_prob","gene_300","gene_anno")
sc3_prob_gene_anno_dir_400 <- here("data","gwas","causal_sim","sc3_prob","gene_400","gene_anno")

sc3_prob_cell_anno_dir_200 <- here("data","expr","causal_sim","sc3_prob","gene_200","cell_anno")
sc3_prob_cell_anno_dir_300 <- here("data","expr","causal_sim","sc3_prob","gene_300","cell_anno")
sc3_prob_cell_anno_dir_400 <- here("data","expr","causal_sim","sc3_prob","gene_400","cell_anno")

sc3_prob_perturbed_expr_dir_200 <- here("data","expr","causal_sim","sc3_prob","gene_200","perturbed_expr")
sc3_prob_perturbed_expr_dir_300 <- here("data","expr","causal_sim","sc3_prob","gene_300","perturbed_expr")
sc3_prob_perturbed_expr_dir_400 <- here("data","expr","causal_sim","sc3_prob","gene_400","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
load("data/expr/causal_sim/standard_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
set.seed(98)
prob_cell_anno_all <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, is_target = ifelse(1:n() %in% sample(n(), 100), T, F))) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(is_target, "target_cell_type", cell_ontology_class))) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 

##sample random gene sets
prob_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20] )) #get genes without strange parameter fitted

prob_gene_anno_all <- map(prob_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

prob_gene_weight <- prob_gene_anno_all %>%
  map(~map(.x, ~{
    gene_pos_zscore <- filter(.x, ZSTAT > 0)
    pull(gene_pos_zscore, ZSTAT) %>% set_names(pull(gene_pos_zscore, mmu_symbol))
  }))

set.seed(100)
prob_gene_anno_200 = prob_gene_anno_all %>%
  #map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map2(prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), 200, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !is_causal)$mmu_symbol, 800), T, F)))) 

prob_gene_anno_300 = prob_gene_anno_all %>%
  #map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map2(prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), 300, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !is_causal)$mmu_symbol, 700), T, F)))) 

prob_gene_anno_400 = prob_gene_anno_all %>%
  #map(~map(.x, ~mutate(.x, may_be_causal = ifelse(ZSTAT>0 & 1:n() <= 1000 , T, F)))) %>%
  map2(prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), 400, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !is_causal)$mmu_symbol, 600), T, F)))) 

##write out cell annotation tables
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_200, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_300, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_400, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))

##write out gene tables
map2(prob_gene_anno_200, names(prob_gene_anno_200), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_200, "/",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(prob_gene_anno_300, names(prob_gene_anno_300), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_300, "/",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(prob_gene_anno_400, names(prob_gene_anno_400), ~{
  expr_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_400, "/",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = seq(0, 2, 0.1) %>% set_names(paste0("es_", format(.,digits = 1)))
effect_size = effect_size[c( "es_1.0", "es_2.0")] #subset for testing

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_prob_perturbed_expr_dir_200, "/",es_name), showWarnings = FALSE)
  map2(prob_gene_anno_200, names(prob_gene_anno_200), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    cell_anno_tbl = prob_cell_anno_all[[expr_name]]
    #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
      
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_dir_200, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_prob_perturbed_expr_dir_300, "/",es_name), showWarnings = FALSE)
  map2(prob_gene_anno_300, names(prob_gene_anno_300), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    cell_anno_tbl = prob_cell_anno_all[[expr_name]]
    #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
      
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_dir_300, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(789)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_prob_perturbed_expr_dir_400, "/",es_name), showWarnings = FALSE)
  map2(prob_gene_anno_400, names(prob_gene_anno_400), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    cell_anno_tbl = prob_cell_anno_all[[expr_name]]
    #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
    map2(.x, names(.x), ~{
      gs_name <- .y
      coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      
      gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
      cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
      
      out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
      write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_dir_400, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
sc3_prob_para_df_200 <- expand_grid(es_name = names(effect_size),
                                        gs_name = names(z_score_list),
                                        expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_dir_200, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_200, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_200, "/", expr_name, ".cell_anno.txt"))

sc3_prob_para_df_300 <- expand_grid(es_name = names(effect_size),
                                    gs_name = names(z_score_list),
                                    expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_dir_300, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_300, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_300, "/", expr_name, ".cell_anno.txt"))

sc3_prob_para_df_400 <- expand_grid(es_name = names(effect_size),
                                    gs_name = names(z_score_list),
                                    expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_dir_400, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_400, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_400, "/", expr_name, ".cell_anno.txt"))

#write out parameter data frame
write.table(sc3_prob_para_df_200 , file = paste0(sc3_prob_perturbed_expr_dir_200, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_300 , file = paste0(sc3_prob_perturbed_expr_dir_300, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_400 , file = paste0(sc3_prob_perturbed_expr_dir_400, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)

##### Try probabilistic gene sets - extended #####
sc3_prob_gene_anno_dir_tot_1000 <- here("data","gwas","causal_sim","sc3_prob_extended","tot_1000","gene_anno")
sc3_prob_gene_anno_dir_tot_2000 <- here("data","gwas","causal_sim","sc3_prob_extended","tot_2000","gene_anno")
sc3_prob_gene_anno_dir_all <- here("data","gwas","causal_sim","sc3_prob_extended","all","gene_anno")
sc3_prob_gene_anno_dir_tot_500 <- here("data","gwas","causal_sim","sc3_prob_extended","tot_500","gene_anno")
sc3_prob_gene_anno_dir_tot_5000 <- here("data","gwas","causal_sim","sc3_prob_extended","tot_5000","gene_anno")

sc3_prob_cell_anno_dir_tot_1000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_1000","cell_anno")
sc3_prob_cell_anno_dir_tot_2000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_2000","cell_anno")
sc3_prob_cell_anno_dir_all <- here("data","expr","causal_sim","sc3_prob_extended","all","cell_anno")
sc3_prob_cell_anno_dir_tot_500 <- here("data","expr","causal_sim","sc3_prob_extended","tot_500","cell_anno")
sc3_prob_cell_anno_dir_tot_5000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_5000","cell_anno")

sc3_prob_perturbed_expr_tot_1000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_1000","perturbed_expr")
sc3_prob_perturbed_expr_tot_2000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_2000","perturbed_expr")
sc3_prob_perturbed_expr_all <- here("data","expr","causal_sim","sc3_prob_extended","all","perturbed_expr")
sc3_prob_perturbed_expr_tot_500 <- here("data","expr","causal_sim","sc3_prob_extended","tot_500","perturbed_expr")
sc3_prob_perturbed_expr_tot_5000 <- here("data","expr","causal_sim","sc3_prob_extended","tot_5000","perturbed_expr")

##sample random cells as target cell types
##load fitted scDesign3 model
load("data/expr/causal_sim/standard_scdesign3_model/sc_para_list.rda")

##sample random cells as target cell types
set.seed(98)
prob_cell_anno_all <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map(~mutate(.x, is_target = ifelse(1:n() %in% sample(n(), 100), T, F))) %>%
  map(~mutate(.x, new_cell_ontology_class = ifelse(is_target, "target_cell_type", cell_ontology_class))) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts")))) 


##sample random gene sets
prob_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20])) 

prob_gene_anno_all <- map(prob_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT)))

prob_gene_weight <- prob_gene_anno_all %>%
  map(~map(.x, ~{
    gene_pos_zscore <- filter(.x, ZSTAT > 0)
    pull(gene_pos_zscore, ZSTAT) %>% set_names(pull(gene_pos_zscore, mmu_symbol))
  }))

set.seed(100)
prob_gene_anno_tot_1000 <- c(0.1, 0.2, 0.3, 0.4, 0.5,0.6,0.8,1.0) %>%
  set_names(c("gr_0.1", "gr_0.2", "gr_0.3", "gr_0.4","gr_0.5", "gr_0.6", "gr_0.8", "gr_1.0")) %>%
  map(~{
    gr<- .x
    map2(prob_gene_anno_all, prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), gr*1000, prob = .y), T, F)))) %>%
      map(~map(.x, ~mutate(.x, is_ct_specific = ifelse(mmu_symbol %in% sample(filter(.x, !is_causal)$mmu_symbol, 1000 - gr*1000), T, F))))}) 

prob_gene_anno_tot_2000 = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.8, 1.0) %>%
  set_names(c("gr_0.1", "gr_0.2", "gr_0.3", "gr_0.4","gr_0.5", "gr_0.6", "gr_0.8", "gr_1.0")) %>%
  map(~{
    gr<- .x
    map2(prob_gene_anno_all, prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), gr*2000, prob = .y), T, F)))) %>%
      map(~map(.x, ~mutate(.x, is_ct_specific = ifelse(mmu_symbol %in% sample(filter(.x, !is_causal)$mmu_symbol, 2000 - gr*2000), T, F))))}) 

prob_gene_anno_tot_all <- prob_gene_anno_all %>%
  map(~map(.x, ~mutate(.x, FDR = p.adjust(P, method="fdr")))) %>%
  map(~map(.x, ~mutate(.x, is_significant = ifelse(FDR<=0.05, T,F)))) 

prob_gene_anno_tot_all <- c(0.2, 0.5, 1) %>%
  set_names(c("gr_0.2", "gr_0.5", "gr_1.0")) %>%
  map(~{
    gr <- .x
    causal_genes <- map(prob_gene_anno_tot_all, ~map(.x, ~filter(.x, is_significant) %>% pull(mmu_symbol))) %>%
      map(~map(.x, ~sample(.x, size = ceiling(length(.x)*gr))))
    ct_specific_genes <- map(prob_gene_anno_tot_all, ~map(.x, ~filter(.x, !is_significant) %>% pull(mmu_symbol))) %>%
      map(~map(.x, ~sample(.x, size = 1000)))
    map2(prob_gene_anno_tot_all, causal_genes, ~map2(.x, .y, ~mutate(.x, is_causal = ifelse(mmu_symbol %in% .y, T,F)))) %>%
      map2(ct_specific_genes, ~map2(.x,.y, ~mutate(.x, is_ct_specific = ifelse(mmu_symbol %in% .y, T,F))))
  })

prob_gene_anno_tot_500 = c(0.2,  0.4,  0.6, 0.8, 1.0) %>%
  set_names(c( "gr_0.2", "gr_0.4", "gr_0.6", "gr_0.8", "gr_1.0")) %>%
  map(~{
    gr<- .x
    map2(prob_gene_anno_all, prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), gr*500, prob = .y), T, F)))) %>%
      map(~map(.x, ~mutate(.x, is_ct_specific = ifelse(mmu_symbol %in% sample(filter(.x, !is_causal)$mmu_symbol, 500 - gr*500), T, F))))}) 

prob_gene_anno_tot_5000 = c(0.2, 0.4, 0.6, 0.8, 1.0) %>%
  set_names(c( "gr_0.2", "gr_0.4", "gr_0.6", "gr_0.8", "gr_1.0")) %>%
  map(~{
    gr<- .x
    map2(prob_gene_anno_all, prob_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), gr*5000, prob = .y), T, F)))) %>%
      map(~map(.x, ~mutate(.x, is_ct_specific = ifelse(mmu_symbol %in% sample(filter(.x, !is_causal)$mmu_symbol, 5000 - gr*5000), T, F))))}) 

##write out cell annotation tables
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_tot_1000, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_tot_2000, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_all, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_tot_500, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(prob_cell_anno_all, names(prob_cell_anno_all), ~write.table(.x, file = paste0(sc3_prob_cell_anno_dir_tot_5000, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))

##write out gene tables
map2(prob_gene_anno_tot_1000, names(prob_gene_anno_tot_1000), ~{
  gr <- .y
  map2(.x,names(.x), ~{
    expr_name <- .y
    map2(.x, names(.x), ~{
      if (! file.exists( paste0(sc3_prob_gene_anno_dir_tot_1000, "/",gr,".",expr_name,".", .y,".gene_anno.txt"))){
        write.table(.x,file= paste0(sc3_prob_gene_anno_dir_tot_1000, "/",gr,".",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F)
      }} )
  })})

map2(prob_gene_anno_tot_2000, names(prob_gene_anno_tot_2000), ~{
  gr <- .y
  map2(.x,names(.x), ~{
    expr_name <- .y
    map2(.x, names(.x), ~{
      if (! file.exists( paste0(sc3_prob_gene_anno_dir_tot_2000, "/",gr,".",expr_name,".", .y,".gene_anno.txt"))){
        write.table(.x,file= paste0(sc3_prob_gene_anno_dir_tot_2000, "/",gr,".",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F)}})
  })})

map2(prob_gene_anno_tot_all, names(prob_gene_anno_tot_all), ~{
  gr <- .y
  map2(.x,names(.x), ~{
    expr_name <- .y
    map2(.x, names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_all, "/",gr,".",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))
  })})

map2(prob_gene_anno_tot_500, names(prob_gene_anno_tot_500), ~{
  gr <- .y
  map2(.x,names(.x), ~{
    expr_name <- .y
    map2(.x, names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_tot_500, "/",gr,".",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))
  })})

map2(prob_gene_anno_tot_5000, names(prob_gene_anno_tot_5000), ~{
  gr <- .y
  map2(.x,names(.x), ~{
    expr_name <- .y
    map2(.x, names(.x), ~write.table(.x,file= paste0(sc3_prob_gene_anno_dir_tot_5000, "/",gr,".",expr_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))
  })})



## perturb expression
effect_size = c(0.05, 0.1, 0.5, 1, 2, 5) %>% set_names(c("es_0.05", "es_0.1", "es_0.5","es_1.0","es_2.0","es_5.0"))

#perturb
set.seed(123)

map2(prob_gene_anno_tot_1000, names(prob_gene_anno_tot_1000), ~{
  prob_gene_anno_list <- .x
  gr_name <- .y
  print(gr_name)
  dir.create(paste0(sc3_prob_perturbed_expr_tot_1000, "/",gr_name), showWarnings = FALSE)
  map2(effect_size, names(effect_size), ~{
    es <- .x
    es_name <- .y
    dir.create(paste0(sc3_prob_perturbed_expr_tot_1000, "/",gr_name, "/",es_name), showWarnings = FALSE)
    map2(prob_gene_anno_list, names(prob_gene_anno_list), ~{
      expr_name <- .y
      sce <- expr_list[[expr_name]]
      cell_anno_tbl = prob_cell_anno_all[[expr_name]]
      #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      map2(.x, names(.x), ~{
        gs_name <- .y
        if (file.exists(paste0(sc3_prob_perturbed_expr_tot_1000,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ))){
          return(NULL)
        }
        coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
        
        gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
        cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
        
        out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
    
        write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_tot_1000,"/", gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      })
    })
  })
})


set.seed(456)
map2(prob_gene_anno_tot_2000, names(prob_gene_anno_tot_2000), ~{
  prob_gene_anno_list <- .x
  gr_name <- .y
  print(gr_name)
  dir.create(paste0(sc3_prob_perturbed_expr_tot_2000, "/",gr_name), showWarnings = FALSE)
  map2(effect_size, names(effect_size), ~{
    es <- .x
    es_name <- .y
    dir.create(paste0(sc3_prob_perturbed_expr_tot_2000, "/",gr_name, "/",es_name), showWarnings = FALSE)
    map2(prob_gene_anno_list, names(prob_gene_anno_list), ~{
      expr_name <- .y
      sce <- expr_list[[expr_name]]
      cell_anno_tbl = prob_cell_anno_all[[expr_name]]
      #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      map2(.x, names(.x), ~{
        gs_name <- .y
        if (file.exists(paste0(sc3_prob_perturbed_expr_tot_2000,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ))){
          return(NULL)
        }
        coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
        
        gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
        cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
        
        out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
        write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_tot_2000,"/",gr_name,  "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      })
    })
  })
})


set.seed(789)
map2(prob_gene_anno_tot_all, names(prob_gene_anno_tot_all), ~{
  prob_gene_anno_list <- .x
  gr_name <- .y
  dir.create(paste0(sc3_prob_perturbed_expr_all, "/",gr_name), showWarnings = FALSE)
  map2(effect_size, names(effect_size), ~{
    es <- .x
    es_name <- .y
    dir.create(paste0(sc3_prob_perturbed_expr_all, "/",gr_name, "/",es_name), showWarnings = FALSE)
    map2(prob_gene_anno_list, names(prob_gene_anno_list), ~{
      expr_name <- .y
      sce <- expr_list[[expr_name]]
      cell_anno_tbl = prob_cell_anno_all[[expr_name]]
      #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      map2(.x, names(.x), ~{
        gs_name <- .y
        if (file.exists(paste0(sc3_prob_perturbed_expr_all,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ))){
          return(NULL)
        }
        coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
        
        gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
        cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
        
        out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
        write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_all,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      })
    })
  })
})

set.seed(012)
map2(prob_gene_anno_tot_500, names(prob_gene_anno_tot_500), ~{
  prob_gene_anno_list <- .x
  gr_name <- .y
  print(gr_name)
  dir.create(paste0(sc3_prob_perturbed_expr_tot_500, "/",gr_name), showWarnings = FALSE)
  map2(effect_size, names(effect_size), ~{
    es <- .x
    es_name <- .y
    dir.create(paste0(sc3_prob_perturbed_expr_tot_500, "/",gr_name, "/",es_name), showWarnings = FALSE)
    map2(prob_gene_anno_list, names(prob_gene_anno_list), ~{
      expr_name <- .y
      sce <- expr_list[[expr_name]]
      cell_anno_tbl = prob_cell_anno_all[[expr_name]]
      #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      map2(.x, names(.x), ~{
        gs_name <- .y
        if (file.exists(paste0(sc3_prob_perturbed_expr_tot_500,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ))){
          return(NULL)
        }
        coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
        
        gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
        cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
        
        out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
        write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_tot_500,"/",gr_name,  "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      })
    })
  })
})

set.seed(345)
map2(prob_gene_anno_tot_5000, names(prob_gene_anno_tot_5000), ~{
  prob_gene_anno_list <- .x
  gr_name <- .y
  print(gr_name)
  dir.create(paste0(sc3_prob_perturbed_expr_tot_5000, "/",gr_name), showWarnings = FALSE)
  map2(effect_size, names(effect_size), ~{
    es <- .x
    es_name <- .y
    dir.create(paste0(sc3_prob_perturbed_expr_tot_5000, "/",gr_name, "/",es_name), showWarnings = FALSE)
    map2(prob_gene_anno_list, names(prob_gene_anno_list), ~{
      expr_name <- .y
      sce <- expr_list[[expr_name]]
      cell_anno_tbl = prob_cell_anno_all[[expr_name]]
      #coldata_df <- gene_num_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
      map2(.x, names(.x), ~{
        gs_name <- .y
        if (file.exists(paste0(sc3_prob_perturbed_expr_tot_5000,"/",gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ))){
          return(NULL)
        }
        coldata_df <-  cell_anno_tbl %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(cell_ontology_class, library_size)
        
        gene_list <- filter(.x, is_causal | is_ct_specific) %>% pull(mmu_symbol)
        cell_list <- cell_anno_tbl$cellid[cell_anno_tbl$is_target] #target cell type
        
        out_mat <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list, geneids = gene_list, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula$copula_list, para_list = sc_para_list[[expr_name]]$para)
        write.table(as.matrix(out_mat), file = paste0(sc3_prob_perturbed_expr_tot_5000,"/",gr_name,  "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
      })
    })
  })
})

## write out parameter df 
prob_output_dir_tot_1000 <- "results/causal_sim/sc3_prob_extended/tot_1000"
sc3_prob_para_df_tot_1000 <- expand_grid(gr_name = names(prob_gene_anno_tot_1000), es_name = names(effect_size), gs_name = names(z_score_list), expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_tot_1000,"/", gr_name,"/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_tot_1000, "/",gr_name,".", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_tot_1000, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(prob_output_dir_tot_1000, "/", gr_name, "/", es_name, "/",gs_name,".",expr_name))

prob_output_dir_tot_2000 <- "results/causal_sim/sc3_prob_extended/tot_2000"
sc3_prob_para_df_tot_2000 <- expand_grid(gr_name = names(prob_gene_anno_tot_2000), es_name = names(effect_size), gs_name = names(z_score_list), expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_tot_2000,"/", gr_name,"/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_tot_2000, "/",gr_name,".", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_tot_2000, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(prob_output_dir_tot_2000, "/", gr_name, "/", es_name, "/",gs_name,".",expr_name))

prob_output_dir_all <- "results/causal_sim/sc3_prob_extended/all"
sc3_prob_para_df_all <-  expand_grid(gr_name = names(prob_gene_anno_tot_all), es_name = names(effect_size), gs_name = names(z_score_list), expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_all,"/", gr_name, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_all, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_all, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(prob_output_dir_all, "/", gr_name, "/", es_name, "/",gs_name,".",expr_name))

prob_output_dir_tot_500 <- "results/causal_sim/sc3_prob_extended/tot_500"
sc3_prob_para_df_tot_500 <- expand_grid(gr_name = names(prob_gene_anno_tot_500), es_name = names(effect_size), gs_name = names(z_score_list), expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_tot_500,"/", gr_name,"/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_tot_500, "/",gr_name,".", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_tot_500, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(prob_output_dir_tot_500, "/", gr_name, "/", es_name, "/",gs_name,".",expr_name))

prob_output_dir_tot_5000 <- "results/causal_sim/sc3_prob_extended/tot_5000"
sc3_prob_para_df_tot_5000 <- expand_grid(gr_name = names(prob_gene_anno_tot_5000), es_name = names(effect_size), gs_name = names(z_score_list), expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_prob_perturbed_expr_tot_5000,"/", gr_name,"/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_prob_gene_anno_dir_tot_5000, "/",gr_name,".", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_prob_cell_anno_dir_tot_5000, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(prob_output_dir_tot_5000, "/", gr_name, "/", es_name, "/",gs_name,".",expr_name))

#write out parameter data frame
write.table(sc3_prob_para_df_tot_1000  , file = paste0(sc3_prob_perturbed_expr_tot_1000, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_tot_2000 , file = paste0(sc3_prob_perturbed_expr_tot_2000, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_all , file = paste0(sc3_prob_perturbed_expr_all, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_tot_500  , file = paste0(sc3_prob_perturbed_expr_tot_500, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_prob_para_df_tot_5000 , file = paste0(sc3_prob_perturbed_expr_tot_5000, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
    

##### Try multiple cell types #####
sc3_multi_ct_gene_anno_dir_random <- here("data","gwas","causal_sim","sc3_multi_ct_500","random","gene_anno")
sc3_multi_ct_gene_anno_dir_no_overlap <- here("data","gwas","causal_sim","sc3_multi_ct_500","no_overlap","gene_anno")
sc3_multi_ct_gene_anno_dir_ct_overlap <- here("data","gwas","causal_sim","sc3_multi_ct_500","ct_overlap","gene_anno")
sc3_multi_ct_gene_anno_dir_causal_overlap <- here("data","gwas","causal_sim","sc3_multi_ct_500","causal_overlap","gene_anno")

sc3_multi_ct_cell_anno_dir_random <- here("data","expr","causal_sim","sc3_multi_ct_500","random","cell_anno")
sc3_multi_ct_cell_anno_dir_no_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","no_overlap","cell_anno")
sc3_multi_ct_cell_anno_dir_ct_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","ct_overlap","cell_anno")
sc3_multi_ct_cell_anno_dir_causal_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","causal_overlap","cell_anno")

sc3_multi_ct_perturbed_expr_dir_random <- here("data","expr","causal_sim","sc3_multi_ct_500","random","perturbed_expr")
sc3_multi_ct_perturbed_expr_dir_no_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","no_overlap","perturbed_expr")
sc3_multi_ct_perturbed_expr_dir_ct_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","ct_overlap","perturbed_expr")
sc3_multi_ct_perturbed_expr_dir_causal_overlap <- here("data","expr","causal_sim","sc3_multi_ct_500","causal_overlap","perturbed_expr")

##sample random cells as target cell types
set.seed(98)
multi_ct_target_cell_1 <- map(expr_list, ~sample(colnames(.x), size = 100))
multi_ct_target_cell_2 <- map2(expr_list,multi_ct_target_cell_1, ~sample(colnames(.x)[!colnames(.x) %in% .y], size = 100))
multi_ct_target_cell_3 <- map2(multi_ct_target_cell_1, multi_ct_target_cell_2, ~cbind(.x, .y)) %>%
  map2(expr_list, ~sample(colnames(.y)[!colnames(.y) %in% .x], size = 100))
  
multi_ct_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts"))))  %>%
  map(~mutate(.x, new_cell_ontology_class = cell_ontology_class)) %>%
  map2(multi_ct_target_cell_1, ~mutate(.x, new_cell_ontology_class = ifelse(cellid %in% .y, "target_cell_type_1",new_cell_ontology_class))) %>%
  map2(multi_ct_target_cell_2, ~mutate(.x, new_cell_ontology_class = ifelse(cellid %in% .y, "target_cell_type_2",new_cell_ontology_class))) %>%
  map2(multi_ct_target_cell_3, ~mutate(.x, new_cell_ontology_class = ifelse(cellid %in% .y, "target_cell_type_3",new_cell_ontology_class)))

##load fitted scDesign3 model
load("data/expr/causal_sim/multi_ct_scdesign3_model/sc_para_list.rda")

##sample random gene sets
multi_ct_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20] )) #get genes without starange parameter fitted


multi_ct_gene_anno_all <- map(multi_ct_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT))) 

multi_cell_gene_weight <- multi_ct_gene_anno_all %>%
  map(~map(.x, ~{
    gene_pos_zscore <- filter(.x, ZSTAT > 0)
    pull(gene_pos_zscore, ZSTAT) %>% set_names(pull(gene_pos_zscore, mmu_symbol))
  }))

set.seed(100)
multi_ct_gene_anno_random = multi_ct_gene_anno_all %>%
  map2(multi_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_1 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(multi_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_2 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(multi_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_3 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_1 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_2 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_2)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_3 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_3)$mmu_symbol, 500), T, F))))

multi_ct_gene_anno_no_overlap = multi_ct_gene_anno_all %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal_1 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~{gl <- .y[names(.y) %in% pull(filter(.x, !is_causal_1), mmu_symbol)]; mutate(.x,  is_causal_2 = ifelse(mmu_symbol %in% sample(names(gl), 500, prob = gl), T, F))})) %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~{gl <- .y[names(.y) %in% pull(filter(.x, !is_causal_1 & !is_causal_2), mmu_symbol)]; mutate(.x,  is_causal_3 = ifelse(mmu_symbol %in% sample(names(gl), 500, prob = gl), T, F))})) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_1 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1 & !is_causal_2 & !is_causal_3)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_2 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1 & !is_causal_2 & !is_causal_3 & !is_ct_specific_1)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_3 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1 & !is_causal_2 & !is_causal_3 & !is_ct_specific_1 & !is_ct_specific_2)$mmu_symbol, 500), T, F)))) 

multi_ct_gene_anno_ct_overlap = multi_ct_gene_anno_all %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal_1 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~{gl <- .y[names(.y) %in% pull(filter(.x, !is_causal_1), mmu_symbol)]; mutate(.x,  is_causal_2 = ifelse(mmu_symbol %in% sample(names(gl), 500, prob = gl), T, F))})) %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~{gl <- .y[names(.y) %in% pull(filter(.x, !is_causal_1 & !is_causal_2), mmu_symbol)]; mutate(.x,  is_causal_3 = ifelse(mmu_symbol %in% sample(names(gl), 500, prob = gl), T, F))})) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1 & !is_causal_2 & !is_causal_3)$mmu_symbol, 500), T, F)))) 

multi_ct_gene_anno_causal_overlap = multi_ct_gene_anno_all %>%
  map2(multi_cell_gene_weight , ~map2(.x,.y, ~mutate(.x,  is_causal = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_1 = ifelse(mmu_symbol %in% sample(filter(., !is_causal)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_2 = ifelse(mmu_symbol %in% sample(filter(., !is_causal & !is_ct_specific_1)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_3 = ifelse(mmu_symbol %in% sample(filter(., !is_causal & !is_ct_specific_1 & !is_ct_specific_2)$mmu_symbol, 500), T, F)))) 

##write out cell annotation tables
map2(multi_ct_cell_anno , names(multi_ct_cell_anno), ~write.table(.x, file = paste0(sc3_multi_ct_cell_anno_dir_random, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(multi_ct_cell_anno , names(multi_ct_cell_anno), ~write.table(.x, file = paste0(sc3_multi_ct_cell_anno_dir_no_overlap, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(multi_ct_cell_anno , names(multi_ct_cell_anno), ~write.table(.x, file = paste0(sc3_multi_ct_cell_anno_dir_ct_overlap, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(multi_ct_cell_anno , names(multi_ct_cell_anno), ~write.table(.x, file = paste0(sc3_multi_ct_cell_anno_dir_causal_overlap, "/", .y,".cell_anno.txt"), quote = F,row.names = F,sep="\t"))

##write out gene tables
map2(multi_ct_gene_anno_random, names(multi_ct_gene_anno_random), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_multi_ct_gene_anno_dir_random, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(multi_ct_gene_anno_no_overlap, names(multi_ct_gene_anno_no_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_multi_ct_gene_anno_dir_no_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(multi_ct_gene_anno_ct_overlap, names(multi_ct_gene_anno_ct_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_multi_ct_gene_anno_dir_ct_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

map2(multi_ct_gene_anno_causal_overlap, names(multi_ct_gene_anno_causal_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_multi_ct_gene_anno_dir_causal_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = c(0.05, 0.1, 0.5, 1, 2, 5) %>% set_names(c("es_0.05", "es_0.1", "es_0.5","es_1.0","es_2.0","es_5.0"))

#perturb
set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_multi_ct_perturbed_expr_dir_random, "/",es_name), showWarnings = FALSE)
  map2(multi_ct_gene_anno_random, names(multi_ct_gene_anno_random), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- multi_ct_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list_1 <- filter(.x, is_causal_1 | is_ct_specific_1) %>% pull(mmu_symbol)
      gene_list_2 <- filter(.x, is_causal_2 | is_ct_specific_2) %>% pull(mmu_symbol)
      gene_list_3 <- filter(.x, is_causal_3 | is_ct_specific_3) %>% pull(mmu_symbol)
      
      cell_list_1 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_1"] #target cell type
      cell_list_2 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_2"] #target cell type
      cell_list_3 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_3"] #target cell type
      
      out_mat_1 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_1, geneids = gene_list_1, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_2 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_2, geneids = gene_list_2, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_3 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_3, geneids = gene_list_3, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      
      aux_mat <- assay(sce,"counts")[match(unique(c(gene_list_1,gene_list_2,gene_list_3)), rownames(sce)), match(c(cell_list_1, cell_list_2, cell_list_3), colnames(sce))] %>% as.matrix()
      aux_mat[match(gene_list_1, rownames(aux_mat)), match(cell_list_1, colnames(aux_mat))] <- out_mat_1
      aux_mat[match(gene_list_2, rownames(aux_mat)), match(cell_list_2, colnames(aux_mat))] <- out_mat_2
      aux_mat[match(gene_list_3, rownames(aux_mat)), match(cell_list_3, colnames(aux_mat))] <- out_mat_3
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_multi_ct_perturbed_expr_dir_random, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_multi_ct_perturbed_expr_dir_no_overlap, "/",es_name), showWarnings = FALSE)
  map2(multi_ct_gene_anno_no_overlap, names(multi_ct_gene_anno_no_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- multi_ct_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list_1 <- filter(.x, is_causal_1 | is_ct_specific_1) %>% pull(mmu_symbol)
      gene_list_2 <- filter(.x, is_causal_2 | is_ct_specific_2) %>% pull(mmu_symbol)
      gene_list_3 <- filter(.x, is_causal_3 | is_ct_specific_3) %>% pull(mmu_symbol)
      
      cell_list_1 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_1"] #target cell type
      cell_list_2 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_2"] #target cell type
      cell_list_3 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_3"] #target cell type
      
      out_mat_1 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_1, geneids = gene_list_1, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_2 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_2, geneids = gene_list_2, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_3 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_3, geneids = gene_list_3, 
                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      
      aux_mat <- assay(sce,"counts")[match(unique(c(gene_list_1,gene_list_2,gene_list_3)), rownames(sce)), match(c(cell_list_1, cell_list_2, cell_list_3), colnames(sce))] %>% as.matrix()
      aux_mat[match(gene_list_1, rownames(aux_mat)), match(cell_list_1, colnames(aux_mat))] <- out_mat_1
      aux_mat[match(gene_list_2, rownames(aux_mat)), match(cell_list_2, colnames(aux_mat))] <- out_mat_2
      aux_mat[match(gene_list_3, rownames(aux_mat)), match(cell_list_3, colnames(aux_mat))] <- out_mat_3
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_multi_ct_perturbed_expr_dir_no_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(789)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_multi_ct_perturbed_expr_dir_ct_overlap, "/",es_name), showWarnings = FALSE)
  map2(multi_ct_gene_anno_ct_overlap, names(multi_ct_gene_anno_ct_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- multi_ct_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      if (file.exists( paste0(sc3_multi_ct_perturbed_expr_dir_ct_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ) )){
        return(NULL)
      }
      gene_list_1 <- filter(.x, is_causal_1 | is_ct_specific) %>% pull(mmu_symbol)
      gene_list_2 <- filter(.x, is_causal_2 | is_ct_specific) %>% pull(mmu_symbol)
      gene_list_3 <- filter(.x, is_causal_3 | is_ct_specific) %>% pull(mmu_symbol)
      
      cell_list_1 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_1"] #target cell type
      cell_list_2 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_2"] #target cell type
      cell_list_3 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_3"] #target cell type
      
      out_mat_1 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_1, geneids = gene_list_1, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_2 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_2, geneids = gene_list_2, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_3 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_3, geneids = gene_list_3, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      
      aux_mat <- assay(sce,"counts")[match(unique(c(gene_list_1,gene_list_2,gene_list_3)), rownames(sce)), match(c(cell_list_1, cell_list_2, cell_list_3), colnames(sce))] %>% as.matrix()
      aux_mat[match(gene_list_1, rownames(aux_mat)), match(cell_list_1, colnames(aux_mat))] <- out_mat_1
      aux_mat[match(gene_list_2, rownames(aux_mat)), match(cell_list_2, colnames(aux_mat))] <- out_mat_2
      aux_mat[match(gene_list_3, rownames(aux_mat)), match(cell_list_3, colnames(aux_mat))] <- out_mat_3
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_multi_ct_perturbed_expr_dir_ct_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})

set.seed(012)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_multi_ct_perturbed_expr_dir_causal_overlap, "/",es_name), showWarnings = FALSE)
  map2(multi_ct_gene_anno_causal_overlap, names(multi_ct_gene_anno_causal_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- multi_ct_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_list_1 <- filter(.x, is_causal | is_ct_specific_1) %>% pull(mmu_symbol)
      gene_list_2 <- filter(.x, is_causal | is_ct_specific_2) %>% pull(mmu_symbol)
      gene_list_3 <- filter(.x, is_causal | is_ct_specific_3) %>% pull(mmu_symbol)
      
      cell_list_1 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_1"] #target cell type
      cell_list_2 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_2"] #target cell type
      cell_list_3 <- rownames(coldata_df)[coldata_df$cell_ontology_class == "target_cell_type_3"] #target cell type
      
      out_mat_1 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_1, geneids = gene_list_1, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_2 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_2, geneids = gene_list_2, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      out_mat_3 <- perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list_3, geneids = gene_list_3, 
                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix()
      
      aux_mat <- assay(sce,"counts")[match(unique(c(gene_list_1,gene_list_2,gene_list_3)), rownames(sce)), match(c(cell_list_1, cell_list_2, cell_list_3), colnames(sce))] %>% as.matrix()
      aux_mat[match(gene_list_1, rownames(aux_mat)), match(cell_list_1, colnames(aux_mat))] <- out_mat_1
      aux_mat[match(gene_list_2, rownames(aux_mat)), match(cell_list_2, colnames(aux_mat))] <- out_mat_2
      aux_mat[match(gene_list_3, rownames(aux_mat)), match(cell_list_3, colnames(aux_mat))] <- out_mat_3
      
      write.table(as.matrix(aux_mat), file = paste0(sc3_multi_ct_perturbed_expr_dir_causal_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
    })
  })
})


## write out parameter df 
#multi_ct_output_dir_random <- "results/causal_sim/sc3_multi_ct/random"
multi_ct_output_dir_random <- "results/causal_sim/sc3_multi_ct_500/random"
sc3_multi_ct_para_df_random <- expand_grid(es_name = names(effect_size),
                                        gs_name = names(z_score_list),
                                        expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_multi_ct_perturbed_expr_dir_random, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_multi_ct_gene_anno_dir_random, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_multi_ct_cell_anno_dir_random, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(multi_ct_output_dir_random , "/", es_name, "/",gs_name,".",expr_name))


#multi_ct_output_dir_no_overlap <- "results/causal_sim/sc3_multi_ct/no_overlap"
multi_ct_output_dir_no_overlap <- "results/causal_sim/sc3_multi_ct_500/no_overlap"
sc3_multi_ct_para_df_no_overlap <- expand_grid(es_name = names(effect_size),
                                           gs_name = names(z_score_list),
                                           expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_multi_ct_perturbed_expr_dir_no_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_multi_ct_gene_anno_dir_no_overlap, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_multi_ct_cell_anno_dir_no_overlap, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(multi_ct_output_dir_no_overlap , "/", es_name, "/",gs_name,".",expr_name))


#multi_ct_output_dir_ct_overlap <- "results/causal_sim/sc3_multi_ct/ct_overlap"
multi_ct_output_dir_ct_overlap <- "results/causal_sim/sc3_multi_ct_500/ct_overlap"
sc3_multi_ct_para_df_ct_overlap <- expand_grid(es_name = names(effect_size),
                                               gs_name = names(z_score_list),
                                               expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_multi_ct_perturbed_expr_dir_ct_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_multi_ct_gene_anno_dir_ct_overlap, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_multi_ct_cell_anno_dir_ct_overlap, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(multi_ct_output_dir_ct_overlap , "/", es_name, "/",gs_name,".",expr_name))


#multi_ct_output_dir_causal_overlap <- "results/causal_sim/sc3_multi_ct/causal_overlap"
multi_ct_output_dir_causal_overlap <- "results/causal_sim/sc3_multi_ct_500/causal_overlap"
sc3_multi_ct_para_df_causal_overlap <- expand_grid(es_name = names(effect_size),
                                               gs_name = names(z_score_list),
                                               expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_multi_ct_perturbed_expr_dir_causal_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_multi_ct_gene_anno_dir_causal_overlap, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_multi_ct_cell_anno_dir_causal_overlap, "/", expr_name, ".cell_anno.txt"),
         output_header = paste0(multi_ct_output_dir_causal_overlap , "/", es_name, "/",gs_name,".",expr_name))


#write out parameter data frame
write.table(sc3_multi_ct_para_df_random , file = paste0(sc3_multi_ct_perturbed_expr_dir_random, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_multi_ct_para_df_no_overlap, file = paste0(sc3_multi_ct_perturbed_expr_dir_no_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_multi_ct_para_df_ct_overlap, file = paste0(sc3_multi_ct_perturbed_expr_dir_ct_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_multi_ct_para_df_causal_overlap, file = paste0(sc3_multi_ct_perturbed_expr_dir_causal_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)




##### Try 10 causal cell types #####
sc3_10_ct_gene_anno_dir_random <- here("data","gwas","causal_sim","sc3_10_ct","random","gene_anno")
sc3_10_ct_gene_anno_dir_no_overlap <- here("data","gwas","causal_sim","sc3_10_ct","no_overlap","gene_anno")
sc3_10_ct_gene_anno_dir_causal_overlap <- here("data","gwas","causal_sim","sc3_10_ct","causal_overlap","gene_anno")
sc3_10_ct_gene_anno_dir_ct_overlap <- here("data","gwas","causal_sim","sc3_10_ct","ct_overlap","gene_anno")

sc3_10_ct_cell_anno_dir_random <- here("data","expr","causal_sim","sc3_10_ct","random","cell_anno")
sc3_10_ct_cell_anno_dir_no_overlap <- here("data","expr","causal_sim","sc3_10_ct","no_overlap","cell_anno")
sc3_10_ct_cell_anno_dir_causal_overlap <- here("data","expr","causal_sim","sc3_10_ct","causal_overlap","cell_anno")
sc3_10_ct_cell_anno_dir_ct_overlap <- here("data","expr","causal_sim","sc3_10_ct","ct_overlap","cell_anno")

sc3_10_ct_perturbed_expr_dir_random <- here("data","expr","causal_sim","sc3_10_ct","random","perturbed_expr")
sc3_10_ct_perturbed_expr_dir_no_overlap <- here("data","expr","causal_sim","sc3_10_ct","no_overlap","perturbed_expr")
sc3_10_ct_perturbed_expr_dir_causal_overlap <- here("data","expr","causal_sim","sc3_10_ct","causal_overlap","perturbed_expr")
sc3_10_ct_perturbed_expr_dir_ct_overlap <- here("data","expr","causal_sim","sc3_10_ct","ct_overlap","perturbed_expr")

##sample random cells as target cell types
set.seed(101)
many_ct_target_cell_all <- map(expr_list, ~sample(colnames(.x), size = 1000)) %>%
  map(~set_names(paste0("target_cell_type_", rep(1:10, each = 100)), .x))

new_cell_ontology_ct <- map2(expr_list, many_ct_target_cell_all, ~.y[colnames(.x)] %>% set_names(colnames(.x)))

sc3_10_ct_cell_anno <- map(expr_list, ~colData(.x)) %>%
  map(~as_tibble(.x)) %>%
  map2(expr_list, ~mutate(.x, library_size = colSums(assay(.y,"counts"))))  %>%
  map(~mutate(.x, new_cell_ontology_class = cell_ontology_class)) %>%
  map2(new_cell_ontology_ct, ~mutate(.x, new_cell_ontology_class = ifelse(is.na(.y), new_cell_ontology_class, .y)))

##load fitted scDesign3 model
load("data/expr/causal_sim/10_ct_scdesign3_model/sc_para_list.new.rda")

##sample gene sets
##sample random gene sets
many_ct_candidate_gene_list <- map(expr_list, ~assay(.x, "counts") > 0)%>%
  map(~rowSums(.x)) %>%
  map(~names(which(.x > 10))) %>%
  map2(names(.), ~intersect(.x, colnames(sc_para_list[[.y]]$para$mean_mat)[colSums(sc_para_list[[.y]]$para$mean_mat)<1e20] )) #get genes without starange parameter fitted


many_ct_gene_anno_all <- map(many_ct_candidate_gene_list, ~{
  gl <- .x
  map(z_score_list, ~mutate(.x, in_perturb_list = ifelse(mmu_symbol %in% gl & in_expr, TRUE, FALSE)))
}) %>%
  map(~map(.x, ~filter(.x, in_perturb_list))) %>%
  map(~map(.x, ~arrange(.x,-ZSTAT))) 

many_cell_gene_weight <- many_ct_gene_anno_all %>%
  map(~map(.x, ~{
    gene_pos_zscore <- filter(.x, ZSTAT > 0)
    pull(gene_pos_zscore, ZSTAT) %>% set_names(pull(gene_pos_zscore, mmu_symbol))
  }))

set.seed(100)
many_ct_gene_anno_random = many_ct_gene_anno_all %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_1 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_2 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_3 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_4 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_5 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_6 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_7 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_8 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_9 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  is_causal_10 = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_1 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_1)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_2 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_2)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_3 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_3)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_4 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_4)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_5 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_5)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_6 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_6)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_7 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_7)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_8 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_8)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_9 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_9)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  is_ct_specific_10 = ifelse(mmu_symbol %in% sample(filter(., !is_causal_10)$mmu_symbol, 500), T, F)))) 

many_ct_gene_anno_no_overlap = many_ct_gene_anno_all %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  may_be_causal = ifelse(mmu_symbol %in% sample(names(.y), 5000, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  may_be_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 5000), T, F)))) %>%
  map(~map(.x, ~sample_frac(.x) %>% arrange(-may_be_causal))) %>%
  map(~map(.x, ~mutate(.x, is_causal = c(paste0("is_causal_", rep(1:10, each = 500)), rep("other", nrow(.x) - 5000))))) %>%
  map(~map(.x, ~sample_frac(.x) %>% arrange(-may_be_ct_specific))) %>%
  map(~map(.x, ~mutate(.x, is_ct_specific = c(paste0("is_ct_specific_", rep(1:10, each = 500)), rep("other", nrow(.x) - 5000))))) 

many_ct_gene_anno_causal_overlap = many_ct_gene_anno_all %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  may_be_causal = ifelse(mmu_symbol %in% sample(names(.y), 500, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  may_be_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 5000), T, F)))) %>%
  map(~map(.x, ~mutate(.x, is_causal = ifelse(may_be_causal, "is_causal","other")))) %>%
  map(~map(.x, ~sample_frac(.x) %>% arrange(-may_be_ct_specific))) %>%
  map(~map(.x, ~mutate(.x, is_ct_specific = c(paste0("is_ct_specific_", rep(1:10, each = 500)), rep("other", nrow(.x) - 5000))))) 

many_ct_gene_anno_ct_overlap = many_ct_gene_anno_all %>%
  map2(many_cell_gene_weight, ~map2(.x,.y, ~mutate(.x,  may_be_causal = ifelse(mmu_symbol %in% sample(names(.y), 5000, prob = .y), T, F)))) %>%
  map(~map(.x, ~mutate(.x,  may_be_ct_specific = ifelse(mmu_symbol %in% sample(filter(., !may_be_causal)$mmu_symbol, 500), T, F)))) %>%
  map(~map(.x, ~sample_frac(.x) %>% arrange(-may_be_causal))) %>%
  map(~map(.x, ~mutate(.x, is_causal = c(paste0("is_causal_", rep(1:10, each = 500)), rep("other", nrow(.x) - 5000))))) %>%
  map(~map(.x, ~mutate(.x, is_ct_specific = ifelse(may_be_ct_specific, "is_ct_specific", "other")))) 


##write out cell annotation tables
map2(sc3_10_ct_cell_anno , names(sc3_10_ct_cell_anno), ~write.table(.x, file = paste0(sc3_10_ct_cell_anno_dir_random, "/", .y,".new.cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(sc3_10_ct_cell_anno , names(sc3_10_ct_cell_anno), ~write.table(.x, file = paste0(sc3_10_ct_cell_anno_dir_no_overlap, "/", .y,".new.cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(sc3_10_ct_cell_anno , names(sc3_10_ct_cell_anno), ~write.table(.x, file = paste0(sc3_10_ct_cell_anno_dir_causal_overlap, "/", .y,".new.cell_anno.txt"), quote = F,row.names = F,sep="\t"))
map2(sc3_10_ct_cell_anno , names(sc3_10_ct_cell_anno), ~write.table(.x, file = paste0(sc3_10_ct_cell_anno_dir_ct_overlap, "/", .y,".new.cell_anno.txt"), quote = F,row.names = F,sep="\t"))

##write out gene tables
map2(many_ct_gene_anno_random, names(many_ct_gene_anno_random), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_10_ct_gene_anno_dir_random, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})
map2(many_ct_gene_anno_no_overlap, names(many_ct_gene_anno_no_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_10_ct_gene_anno_dir_no_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})
map2(many_ct_gene_anno_causal_overlap, names(many_ct_gene_anno_causal_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_10_ct_gene_anno_dir_causal_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})
map2(many_ct_gene_anno_ct_overlap, names(many_ct_gene_anno_ct_overlap), ~{
  gs_name <- .y
  map2(.x,names(.x), ~write.table(.x,file= paste0(sc3_10_ct_gene_anno_dir_ct_overlap, "/",gs_name,".", .y,".gene_anno.txt"), quote = F,row.names = F))})

## perturb expression
effect_size = c(0.05, 0.1, 0.5, 1, 2, 5) %>% set_names(c("es_0.05", "es_0.1", "es_0.5","es_1.0","es_2.0","es_5.0"))

#sample and write out
# set.seed(123)
# map2(effect_size, names(effect_size), ~{
#   es <- .x
#   es_name <- .y
#   dir.create(paste0(sc3_many_ct_perturbed_expr_dir_random, "/",es_name), showWarnings = FALSE)
#   map2(many_ct_gene_anno_random, names(many_ct_gene_anno_random), ~{
#     expr_name <- .y
#     sce <- expr_list[[expr_name]]
#     coldata_df <- multi_ct_cell_anno[[expr_name]] %>% as.data.frame() %>% set_rownames(.$cellid) %>% select(new_cell_ontology_class, library_size) %>% set_colnames(c("cell_ontology_class","library_size"))
#     map2(.x, names(.x), ~{
#       gs_name <- .y
#       gene_tbl <- .x
#       gene_list <- map(1:10, ~filter(gene_tbl, .data[[paste0("is_causal_",.x)]] | .data[[paste0("is_ct_specific_",.x)]] ) %>% pull(mmu_symbol))
#       cell_list <- map(1:10, ~rownames(coldata_df)[coldata_df$cell_ontology_class == paste0("target_cell_type_", .x)])
#       out_mat_list <- map(1:10, ~ perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list[[.x]], geneids = gene_list[[.x]],
#                                                        effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix())
#       
#       aux_mat <- assay(sce,"counts")[unique(purrr::reduce(gene_list, ~c(.x,.y))), rownames(sce)), match(unique(purrr::reduce(cell_list, ~c(.x,.y))), colnames(sce))] %>% as.matrix()
#       
#       pmap(list(gene_list, cell_list, out_mat_list), ~ {
#         indices_genes <- match(..1, rownames(aux_mat))
#         indices_cells <- match(..2, colnames(aux_mat))
#         aux_mat[indices_genes, indices_cells] <<- ..3
#       })
#       
#       write.table(as.matrix(aux_mat), file = paste0(sc3_10_ct_perturbed_expr_dir_random, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ), row.names = T, col.names = T, quote = F)
#     })
#   })
# })

set.seed(123)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_10_ct_perturbed_expr_dir_random, "/", es_name), showWarnings = FALSE)
  map2(many_ct_gene_anno_random, names(many_ct_gene_anno_random), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- sc3_10_ct_cell_anno[[expr_name]] %>%
      as.data.frame() %>%
      set_rownames(.$cellid) %>%
      select(new_cell_ontology_class, library_size) %>%
      set_colnames(c("cell_ontology_class", "library_size"))
    
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_tbl <- .x
      gene_list <- map(1:10, ~filter(gene_tbl, .data[[paste0("is_causal_", .x)]] | .data[[paste0("is_ct_specific_", .x)]]) %>% pull(mmu_symbol))
      cell_list <- map(1:10, ~rownames(coldata_df)[coldata_df$cell_ontology_class == paste0("target_cell_type_", .x)])
      out_mat_list <- map(1:10, ~perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list[[.x]], geneids = gene_list[[.x]],
                                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix())
      
      aux_mat <- assay(sce, "counts")[unique(purrr::reduce(gene_list, ~c(.x, .y))), match(unique(purrr::reduce(cell_list, ~c(.x, .y))), colnames(sce))] %>% as.matrix()
      
      pmap(list(gene_list, cell_list, out_mat_list), ~ {
        indices_genes <- match(..1, rownames(aux_mat))
        indices_cells <- match(..2, colnames(aux_mat))
        aux_mat[indices_genes, indices_cells] <<- ..3
      })
      
      dir.create(paste0(sc3_10_ct_perturbed_expr_dir_random, "/", es_name), showWarnings = FALSE)
      write.table(as.matrix(aux_mat), file = paste0(sc3_10_ct_perturbed_expr_dir_random, "/", es_name, "/", gs_name, ".", expr_name, ".perturbed_mat.txt"), row.names = TRUE, col.names = TRUE, quote = FALSE)
    })
  })
})

set.seed(456)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_10_ct_perturbed_expr_dir_no_overlap, "/", es_name), showWarnings = FALSE)
  map2(many_ct_gene_anno_no_overlap, names(many_ct_gene_anno_no_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- sc3_10_ct_cell_anno[[expr_name]] %>%
      as.data.frame() %>%
      set_rownames(.$cellid) %>%
      select(new_cell_ontology_class, library_size) %>%
      set_colnames(c("cell_ontology_class", "library_size"))
    
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_tbl <- .x
      gene_list <- map(1:10, ~filter(gene_tbl,  is_causal == paste0("is_causal_", .x)|  is_ct_specific == paste0("is_ct_specific_", .x)) %>% pull(mmu_symbol))
      cell_list <- map(1:10, ~rownames(coldata_df)[coldata_df$cell_ontology_class == paste0("target_cell_type_", .x)])
      out_mat_list <- map(1:10, ~perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list[[.x]], geneids = gene_list[[.x]],
                                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix())
      
      aux_mat <- assay(sce, "counts")[unique(purrr::reduce(gene_list, ~c(.x, .y))), match(unique(purrr::reduce(cell_list, ~c(.x, .y))), colnames(sce))] %>% as.matrix()
      
      pmap(list(gene_list, cell_list, out_mat_list), ~ {
        indices_genes <- match(..1, rownames(aux_mat))
        indices_cells <- match(..2, colnames(aux_mat))
        aux_mat[indices_genes, indices_cells] <<- ..3
      })
      
      dir.create(paste0(sc3_10_ct_perturbed_expr_dir_no_overlap, "/", es_name), showWarnings = FALSE)
      write.table(as.matrix(aux_mat), file = paste0(sc3_10_ct_perturbed_expr_dir_no_overlap, "/", es_name, "/", gs_name, ".", expr_name, ".perturbed_mat.txt"), row.names = TRUE, col.names = TRUE, quote = FALSE)
    })
  })
})

set.seed(789)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", es_name), showWarnings = FALSE)
  map2(many_ct_gene_anno_causal_overlap, names(many_ct_gene_anno_causal_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- sc3_10_ct_cell_anno[[expr_name]] %>%
      as.data.frame() %>%
      set_rownames(.$cellid) %>%
      select(new_cell_ontology_class, library_size) %>%
      set_colnames(c("cell_ontology_class", "library_size"))
    
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_tbl <- .x
      if (file.exists( paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", es_name, "/", gs_name, ".", expr_name, ".perturbed_mat.txt"))){
        return(NULL)
      }
      gene_list <- map(1:10, ~filter(gene_tbl,  is_causal == paste0("is_causal")|  is_ct_specific == paste0("is_ct_specific_", .x)) %>% pull(mmu_symbol))
      cell_list <- map(1:10, ~rownames(coldata_df)[coldata_df$cell_ontology_class == paste0("target_cell_type_", .x)])
      out_mat_list <- map(1:10, ~perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list[[.x]], geneids = gene_list[[.x]],
                                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix())
      
      aux_mat <- assay(sce, "counts")[match(unique(purrr::reduce(gene_list, ~c(.x, .y))), rownames(sce)), match(unique(purrr::reduce(cell_list, ~c(.x, .y))), colnames(sce))] %>% as.matrix()
      
      pmap(list(gene_list, cell_list, out_mat_list), ~ {
        indices_genes <- match(..1, rownames(aux_mat))
        indices_cells <- match(..2, colnames(aux_mat))
        aux_mat[indices_genes, indices_cells] <<- ..3
      })
      
      dir.create(paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", es_name), showWarnings = FALSE)
      write.table(as.matrix(aux_mat), file = paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", es_name, "/", gs_name, ".", expr_name, ".perturbed_mat.txt"), row.names = TRUE, col.names = TRUE, quote = FALSE)
    })
  })
})

set.seed(012)
map2(effect_size, names(effect_size), ~{
  es <- .x
  es_name <- .y
  dir.create(paste0(sc3_10_ct_perturbed_expr_dir_ct_overlap, "/", es_name), showWarnings = FALSE)
  map2(many_ct_gene_anno_ct_overlap, names(many_ct_gene_anno_ct_overlap), ~{
    expr_name <- .y
    sce <- expr_list[[expr_name]]
    coldata_df <- sc3_10_ct_cell_anno[[expr_name]] %>%
      as.data.frame() %>%
      set_rownames(.$cellid) %>%
      select(new_cell_ontology_class, library_size) %>%
      set_colnames(c("cell_ontology_class", "library_size"))
    
    map2(.x, names(.x), ~{
      gs_name <- .y
      gene_tbl <- .x
      gene_list <- map(1:10, ~filter(gene_tbl,  is_causal == paste0("is_causal_", .x)|  is_ct_specific == "is_ct_specific") %>% pull(mmu_symbol))
      cell_list <- map(1:10, ~rownames(coldata_df)[coldata_df$cell_ontology_class == paste0("target_cell_type_", .x)])
      out_mat_list <- map(1:10, ~perturb_count_matrix(sce = sce, covar_df = coldata_df, cellids = cell_list[[.x]], geneids = gene_list[[.x]],
                                                      effect_size_para = 2^es, copula_para_list = sc_para_list[[expr_name]]$copula, para_list = sc_para_list[[expr_name]]$para) %>% as.matrix())
      
      aux_mat <- assay(sce, "counts")[match(unique(purrr::reduce(gene_list, ~c(.x, .y))), rownames(sce)), match(unique(purrr::reduce(cell_list, ~c(.x, .y))), colnames(sce))] %>% as.matrix()
      
      pmap(list(gene_list, cell_list, out_mat_list), ~ {
        indices_genes <- match(..1, rownames(aux_mat))
        indices_cells <- match(..2, colnames(aux_mat))
        aux_mat[indices_genes, indices_cells] <<- ..3
      })
      
      dir.create(paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", es_name), showWarnings = FALSE)
      write.table(as.matrix(aux_mat), file = paste0(sc3_10_ct_perturbed_expr_dir_ct_overlap, "/", es_name, "/", gs_name, ".", expr_name, ".perturbed_mat.txt"), row.names = TRUE, col.names = TRUE, quote = FALSE)
    })
  })
})

### write out parameter df 
many_ct_output_dir_random <- "results/causal_sim/sc3_10_ct/random"
sc3_10_ct_para_df_random <- expand_grid(es_name = names(effect_size),
                                           gs_name = names(z_score_list),
                                           expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_10_ct_perturbed_expr_dir_random, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_10_ct_gene_anno_dir_random, "/", expr_name,".",gs_name, ".gene_anno.txt"),
         cell_anno_file = paste0(sc3_10_ct_cell_anno_dir_random, "/", expr_name, ".new.cell_anno.txt"),
         output_header = paste0(many_ct_output_dir_random , "/", es_name, "/",gs_name,".",expr_name))


many_ct_output_dir_no_overlap <- "results/causal_sim/sc3_10_ct/no_overlap"
sc3_10_ct_para_df_no_overlap <- expand_grid(es_name = names(effect_size),
                                          gs_name = names(z_score_list),
                                          expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_10_ct_perturbed_expr_dir_no_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_10_ct_gene_anno_dir_no_overlap, "/", expr_name,".",gs_name, ".new.gene_anno.txt"),
         cell_anno_file = paste0(sc3_10_ct_cell_anno_dir_no_overlap, "/", expr_name, ".new.cell_anno.txt"),
         output_header = paste0(many_ct_output_dir_no_overlap , "/", es_name, "/",gs_name,".",expr_name))

many_ct_output_dir_causal_overlap <- "results/causal_sim/sc3_10_ct/causal_overlap"
sc3_10_ct_para_df_causal_overlap <- expand_grid(es_name = names(effect_size),
                                            gs_name = names(z_score_list),
                                            expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_10_ct_gene_anno_dir_causal_overlap, "/", expr_name,".",gs_name, ".new.gene_anno.txt"),
         cell_anno_file = paste0(sc3_10_ct_cell_anno_dir_causal_overlap, "/", expr_name, ".new.cell_anno.txt"),
         output_header = paste0(many_ct_output_dir_causal_overlap , "/", es_name, "/",gs_name,".",expr_name))

many_ct_output_dir_ct_overlap <- "results/causal_sim/sc3_10_ct/ct_overlap"
sc3_10_ct_para_df_ct_overlap <- expand_grid(es_name = names(effect_size),
                                            gs_name = names(z_score_list),
                                            expr_name = names(expr_list)) %>%
  mutate(expr_rda_file = paste0(expr_dir, "/", expr_name, ".rda"),
         expr_h5ad_file = paste0(h5ad_dir, "/", expr_name, ".h5ad"),
         perturbed_mat_file = paste0(sc3_10_ct_perturbed_expr_dir_ct_overlap, "/",es_name, "/", gs_name,".",expr_name,".perturbed_mat.txt" ),
         gs_zscore_file = paste0(zscore_dir, "/", gs_name, ".genes.out"),
         gs_scdrs_file = paste0(scdrs_dir, "/", gs_name, ".gs"),
         magma_raw_file = paste0(magma_raw_dir, "/", gs_name, ".genes.raw"),
         gene_anno_file = paste0(sc3_10_ct_gene_anno_dir_ct_overlap, "/", expr_name,".",gs_name, ".new.gene_anno.txt"),
         cell_anno_file = paste0(sc3_10_ct_cell_anno_dir_ct_overlap, "/", expr_name, ".new.cell_anno.txt"),
         output_header = paste0(many_ct_output_dir_ctoverlap , "/", es_name, "/",gs_name,".",expr_name))

#write out parameter data frame
write.table(sc3_10_ct_para_df_random , file = paste0(sc3_10_ct_perturbed_expr_dir_random, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_10_ct_para_df_no_overlap, file = paste0(sc3_10_ct_perturbed_expr_dir_no_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_10_ct_para_df_causal_overlap , file = paste0(sc3_10_ct_perturbed_expr_dir_causal_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
write.table(sc3_10_ct_para_df_ct_overlap, file = paste0(sc3_10_ct_perturbed_expr_dir_ct_overlap, "/", "parameter_df.txt"), row.names = F, col.names = T, quote = F)
